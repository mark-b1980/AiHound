package com.pentest_experts.aihound;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
//import java.io.BufferedInputStream;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;

import javax.swing.*;

import java.awt.*;
import java.awt.image.BufferedImage;
import java.net.URL;

//import java.nio.Buffer;

import javax.imageio.ImageIO; 

import java.util.Base64;

import org.apache.pdfbox.Loader;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.PDResources;
import org.apache.pdfbox.pdmodel.graphics.image.PDImageXObject;

import org.bytedeco.javacv.Java2DFrameConverter;
import org.bytedeco.javacv.OpenCVFrameConverter;
import org.bytedeco.opencv.global.opencv_videoio;
import org.bytedeco.opencv.opencv_core.Mat;
import org.bytedeco.opencv.opencv_videoio.VideoCapture;

public class AiHoundUi {
    private String houndType;
    private String startPath;
    private JFrame frame = new JFrame("AiHound 2.0");
    private URL iconURL = getClass().getResource("/icon.png");
    private String reportFileName = "aihound.html";
    private int hitCounter = 0;
    private double detectionThreshold = 0.8;
    private String[] houndTypes = {"all", "nudity", "documents", "ID- or creditcards", "drugs", "money"};
    private int reportThumbnailHeight = 96;
    private JLabel statusLabel;
    private JLabel foundImageDisplay;
    private JButton startBtn;

    public static void main(String[] args) {
        // All Swing UI initialization and updates should be on the EDT
        SwingUtilities.invokeLater(() -> {
            AiHoundUi ui = new AiHoundUi();
            ui.mainWindow();
        });
    }

    private String getHoundType() {
        return this.houndType;
    }

    private void setHoundType(String hound_type) {
        this.houndType = hound_type;
    }

    private double getDetectionThreshold() {
        return this.detectionThreshold;
    }

    private void setDetectionThreshold(String thresholdName) {
        if (thresholdName.equals("very lose")) {
            this.detectionThreshold = 0.6;
        } 
        else if (thresholdName.equals("lose")) {
            this.detectionThreshold = 0.7;
        } 
        else if (thresholdName.equals("normal")) {
            this.detectionThreshold = 0.8;
        } 
        else if (thresholdName.equals("strict")) {
            this.detectionThreshold = 0.9;
        } 
        else if (thresholdName.equals("very strict")) {
            this.detectionThreshold = 0.95;
        }
    }

    private String getStartPath() {
        return this.startPath;
    }

    private void setStartPath(String start_path) {
        this.startPath = start_path;
    }

    private void mainWindow() {
        // Load the icon
        try {
            ImageIcon icon = new ImageIcon(ImageIO.read(this.iconURL));
            this.frame.setIconImage(icon.getImage());
        } catch (Exception e) {
            System.err.println("Error loading icon: " + e.getMessage());
            e.printStackTrace();
        }

        this.frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        this.frame.setSize(900, 240);
        this.frame.setLayout(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);

        this.foundImageDisplay = new JLabel();
        this.foundImageDisplay.setHorizontalAlignment(SwingConstants.CENTER);
        this.foundImageDisplay.setBorder(BorderFactory.createTitledBorder("Last found image"));
        
        this.statusLabel = new JLabel("Select folder and click the start button...");
        this.statusLabel.setBorder(BorderFactory.createEtchedBorder());


        JLabel typeLabel = new JLabel("AiHound Type:");
        JComboBox<String> typeCombo = new JComboBox<>(this.houndTypes);

        JLabel thresholdLabel = new JLabel("Detection threshold:");
        String[] thresholds = {"very lose", "lose", "normal", "strict", "very strict"};
        JComboBox<String> thresholdCombo = new JComboBox<>(thresholds);
        thresholdCombo.setSelectedItem("normal");

        JLabel folderLabel = new JLabel("Select Folder:");
        JButton browseBtn = new JButton("Browse");

        this.startBtn = new JButton("Start");

        gbc.gridx = 2;
        gbc.gridy = 0;
        gbc.gridheight = 4;
        gbc.weightx = 1.0;
        gbc.fill = GridBagConstraints.BOTH;
        this.frame.add(this.foundImageDisplay, gbc);

        gbc.gridheight = 1;
        gbc.weightx = 0;
        gbc.fill = GridBagConstraints.HORIZONTAL;

        gbc.gridx = 0;
        gbc.gridy = 0;
        this.frame.add(typeLabel, gbc);
        gbc.gridx = 1;
        gbc.gridy = 0;
        this.frame.add(typeCombo, gbc);

        gbc.gridx = 0;
        gbc.gridy = 1;
        this.frame.add(thresholdLabel, gbc);
        gbc.gridx = 1;
        gbc.gridy = 1;
        this.frame.add(thresholdCombo, gbc);

        gbc.gridx = 0;
        gbc.gridy = 2;
        this.frame.add(folderLabel, gbc);
        gbc.gridx = 1;
        gbc.gridy = 2;
        this.frame.add(browseBtn, gbc);

        gbc.gridx = 1;
        gbc.gridy = 3;
        this.frame.add(startBtn, gbc);

        gbc.gridx = 0;
        gbc.gridy = 4;
        gbc.gridwidth = 3;
        this.frame.add(this.statusLabel, gbc);

        browseBtn.addActionListener(e -> {
            JFileChooser chooser = new JFileChooser();
            chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
            int res = chooser.showOpenDialog(this.frame);
            if (res == JFileChooser.APPROVE_OPTION) {
                String selectedPath = chooser.getSelectedFile().getAbsolutePath();
                this.setStartPath(selectedPath);
                this.updateStatus("Selected folder: " + selectedPath);
            }
        });

        startBtn.addActionListener(e -> {
            this.setHoundType((String) typeCombo.getSelectedItem());
            this.setDetectionThreshold((String) thresholdCombo.getSelectedItem());
            this.updateStatus("Starting analysis with type: " + this.getHoundType() + " and threshold: " + this.getDetectionThreshold() + " ...");
            startBtn.setEnabled(false);
            this.run();
        });

        this.frame.setLocationRelativeTo(null);
        this.frame.setVisible(true);
    }

    public void updateStatus(String statusText) {
        SwingUtilities.invokeLater(() -> this.statusLabel.setText(statusText));
    }

    public void updateFoundImage(BufferedImage image) {
        SwingUtilities.invokeLater(() -> {
            this.foundImageDisplay.setIcon(new ImageIcon(image));
        });
    }

    private void log(String message) {
        try {
            java.nio.file.Files.write(
                    java.nio.file.Paths.get(this.reportFileName),
                    (message + System.lineSeparator()).getBytes(),
                    java.nio.file.StandardOpenOption.CREATE,
                    java.nio.file.StandardOpenOption.APPEND
            );
        } 
        catch (java.io.IOException ex) {
            System.err.println("Log write error: " + ex.getMessage());
        }
    }

    private void run() {
        new Thread(() -> {
            if (this.getStartPath() == null || this.getStartPath().isEmpty()) {
                JOptionPane.showMessageDialog(this.frame, "Please select a folder to analyze.", "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            // Create a report file
            this.reportFileName = "aihound_report_" + System.currentTimeMillis() + ".html";

            // Initialize hit counter and report
            this.hitCounter = 0;
            this.log("<!DOCTYPE html>");
            this.log("<html>");
            this.log("<head><title>AiHound Report</title><style>body{ font-family: sans-serif; } table{ border-collapse: collapse; } td{ padding: 3px; }</style></head>");
            this.log("<body>");
            this.log("<h1>AiHound Report</h1>");
            this.log("<p>AiHound started with type: <b>" + this.getHoundType() + "</b></p>");
            this.log("<p>Starting analysis in folder: <b>" + this.getStartPath() + "</b></p>");
            this.log("<table border='1'><thead><tr><th>Thumbnail</th><th>Class</th><th>File-path</th></tr></thead><tbody>");

            // Create an instance of AiHound.
            AiHound model = new AiHound(); 
            String[] classes = {"document", "drugs", "id_or_creditcard", "money", "neg", "nude"};
            
            File folder = new File(this.getStartPath());
            this.processDirectory(folder, model, classes);

            // Use String.valueOf() or direct concatenation for int to String conversion
            JOptionPane.showMessageDialog(this.frame, "Found " + this.hitCounter + " interesting files in " + this.getStartPath());
            this.log("</tbody></table></body></html>");
        }).start();
    }

    private String createImageThumbnailBase64(String imagePath, int thumbnailHeight) throws IOException {
        // Read the image file
        File imageFile = new File(imagePath);
        if (!imageFile.exists()) {
            throw new IOException("Image file not found: " + imagePath);
        }
        
        BufferedImage originalImage = ImageIO.read(imageFile);
        if (originalImage == null) {
            throw new IOException("Could not read image from: " + imagePath + ". Make sure it's a valid image format.");
        }

        return this.createImageThumbnailBase64Converter(originalImage, thumbnailHeight);
    }

    private String createImageThumbnailBase64(BufferedImage originalImage, int thumbnailHeight) {
        return this.createImageThumbnailBase64Converter(originalImage, thumbnailHeight);
    }

    private String createImageThumbnailBase64Converter(BufferedImage originalImage, int thumbnailHeight) {
        String fileFormat = "jpeg"; // Default format
        
        // Resize the image to a thumbnail
        int originalWidth = originalImage.getWidth();
        int originalHeight = originalImage.getHeight();

        // Calculate new width to maintain aspect ratio
        double aspectRatio = (double) originalWidth / originalHeight;
        int thumbnailWidth = (int) (thumbnailHeight * aspectRatio);

        BufferedImage resizedImage = new BufferedImage(thumbnailWidth, thumbnailHeight, BufferedImage.TYPE_INT_RGB);

        // Update GUI
        this.updateFoundImage(resizedImage);

        // Create Base64 thumbnail image
        Graphics2D g = resizedImage.createGraphics();
        g.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);
        g.drawImage(originalImage, 0, 0, thumbnailWidth, thumbnailHeight, null);
        g.dispose();

        // Convert to Base64
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        try{
            ImageIO.write(resizedImage, fileFormat, bos); // "jpeg" is the format for the output
        }
        catch (IOException e) {
            System.err.println("Error writing image to output stream: " + e.getMessage());
            return ""; // Return empty string on error
        }
        byte[] imageBytes = bos.toByteArray();
        String base64Image = Base64.getEncoder().encodeToString(imageBytes);

        // Construct the <img> tag
        return "data:image/" + fileFormat + ";base64," + base64Image;
    }

    // Helper method to read all bytes from an InputStream
    // needed to create a resetable InputStream for the thumbnail generation
    public byte[] readAllBytes(java.io.InputStream inputStream) throws java.io.IOException {
        final int BUFFER_SIZE = 4096;
        byte[] buffer = new byte[BUFFER_SIZE];
        java.io.ByteArrayOutputStream output = new java.io.ByteArrayOutputStream();
        int bytesRead;
        while ((bytesRead = inputStream.read(buffer, 0, BUFFER_SIZE)) != -1) {
            output.write(buffer, 0, bytesRead);
        }
        return output.toByteArray();
    }

    private void processDirectory(File folder, AiHound model, String[] classes) {
        // Iterate through files in the selected folder
        File[] listOfFiles = folder.listFiles();

        if (listOfFiles == null) {
            System.err.println("Selected path is not a directory or is inaccessible: " + folder.getAbsolutePath());
            return;
        }

        for (File f : listOfFiles) {
            if (f.isFile()) {
                String fPath = f.getPath();
                String lower = fPath.toLowerCase();
                String thumbnailImageExtracted = "";
                InputStream imgStream = null;
                double[] predcition = new double[] {0, 0, 0, 0, 0, 0};
                int i = 0;

                this.updateStatus("PROCESSING: " + f.getPath());

                ///////////////////////////////////////////////////////////////////////////////////////
                /// IMAGES
                ///////////////////////////////////////////////////////////////////////////////////////
                if (lower.endsWith(".png") || lower.endsWith(".jpg") || lower.endsWith(".jpeg") || lower.endsWith(".webp")) {
                    try{
                        imgStream = new FileInputStream(f);
                    }
                    catch (FileNotFoundException e) {
                        System.err.println("File not found: " + fPath);
                        continue; 
                    }

                    // Predict using the model
                    predcition = model.predict(imgStream);
                }

                ///////////////////////////////////////////////////////////////////////////////////////
                /// PDF-FILES
                ///////////////////////////////////////////////////////////////////////////////////////
                else if (lower.endsWith(".pdf")) {
                    double[] predcitionPart = new double[] {0, 0, 0, 0, 0, 0};

                    try (PDDocument document = Loader.loadPDF(f)) {
                        for (PDPage page : document.getPages()) {
                            PDResources resources = page.getResources();

                            if (resources != null) {
                                for (org.apache.pdfbox.cos.COSName name : resources.getXObjectNames()) {
                                    try {
                                        org.apache.pdfbox.pdmodel.graphics.PDXObject xObject = resources.getXObject(name);
                                        
                                        // Check if the object is an image
                                        if (xObject instanceof PDImageXObject) {
                                            PDImageXObject image = (PDImageXObject) xObject;
                                            BufferedImage bufferedImage = image.getImage();

                                            // Convert BufferedImage to InputStream
                                            ByteArrayOutputStream baos = new ByteArrayOutputStream();
                                            ImageIO.write(bufferedImage, "png", baos);
                                            baos.flush();
                                            imgStream = new ByteArrayInputStream(baos.toByteArray());

                                            // Predict using the model
                                            predcitionPart = model.predict(imgStream);

                                            // Combine predictions - report max value for each class
                                            for (i = 0; i < predcition.length; i++) {
                                                if (predcition[i] < predcitionPart[i]){
                                                    predcition[i] = predcitionPart[i];
                                                }
                                                
                                                // Generate thumbnail image for first prediction exceeding the threshold
                                                if (thumbnailImageExtracted == "" && predcition[i] > this.getDetectionThreshold() && i != 4) {
                                                    thumbnailImageExtracted = this.createImageThumbnailBase64(bufferedImage, this.reportThumbnailHeight);
                                                }
                                            }
                                        }
                                    } catch (IOException e) {
                                        System.err.println("Error processing object: " + e.getMessage());
                                    }
                                }
                            }                                
                        }
                    } 
                    catch (IOException e) {
                        System.err.println("Error reading PDF file: " + fPath);
                        continue; 
                    }
                }

                ///////////////////////////////////////////////////////////////////////////////////////
                /// ZIP- AND OFFICE-FILES
                ///////////////////////////////////////////////////////////////////////////////////////
                else if (lower.endsWith(".zip") || lower.endsWith(".docx") || lower.endsWith(".xlsx") || lower.endsWith(".pptx")) {
                    double[] predcitionPart = new double[] {0, 0, 0, 0, 0, 0};
                    
                    try (java.util.zip.ZipFile zipFile = new java.util.zip.ZipFile(f)) {
                        java.util.Enumeration<? extends java.util.zip.ZipEntry> entries = zipFile.entries();
                        while (entries.hasMoreElements()) {
                            java.util.zip.ZipEntry entry = entries.nextElement();
                            if (!entry.isDirectory() && (entry.getName().endsWith(".png") || entry.getName().endsWith(".jpg") || entry.getName().endsWith(".jpeg") || entry.getName().endsWith(".webp"))) {
                                imgStream = zipFile.getInputStream(entry);
                                predcition = model.predict(imgStream);

                                // Combine predictions - report max value for each class
                                for (i = 0; i < predcition.length; i++) {
                                    if (predcition[i] < predcitionPart[i]){
                                        predcition[i] = predcitionPart[i];
                                    }

                                    // Generate thumbnail image for first prediction exceeding the threshold
                                    if (thumbnailImageExtracted == "" && predcition[i] > this.getDetectionThreshold() && i != 4) {
                                        imgStream = zipFile.getInputStream(entry);
                                        ByteArrayOutputStream baos = new ByteArrayOutputStream();
                                        imgStream.transferTo(baos);
                                        InputStream inMemoryStream = new ByteArrayInputStream(baos.toByteArray());
                                        BufferedImage bufferedImage = ImageIO.read(inMemoryStream); 
                                        if (bufferedImage != null) {
                                            thumbnailImageExtracted = this.createImageThumbnailBase64(bufferedImage, this.reportThumbnailHeight);
                                        }
                                    }
                                }
                            }
                        }
                    } 
                    catch (IOException ex) {
                        System.err.println("Error reading ZIP file: " + fPath + " - " + ex.getMessage());
                        continue; 
                    }
                }

                ///////////////////////////////////////////////////////////////////////////////////////
                /// MOVIES
                ///////////////////////////////////////////////////////////////////////////////////////
                else if (lower.endsWith(".mp4") || lower.endsWith(".avi") || lower.endsWith(".wmv") || lower.endsWith(".mov")) {
                    double[] predcitionPart = new double[] {0, 0, 0, 0, 0, 0};
                    VideoCapture cap = new VideoCapture(f.getAbsolutePath());
                    OpenCVFrameConverter.ToMat matConverter = new OpenCVFrameConverter.ToMat();
                    Java2DFrameConverter java2dConverter = new Java2DFrameConverter();

                    if (!cap.isOpened()) {
                        System.err.println("Error opening video file: " + fPath);
                        continue; 
                    }

                    long totalFrames = (long) cap.get(opencv_videoio.CAP_PROP_FRAME_COUNT);
                    if (totalFrames <= 0) {
                        System.err.println("Unable to get total frames from video file: " + f.getAbsolutePath());
                        continue;
                    }
                    
                    // Calculate frame skip interval to process only 10 frames
                    long frameSkipInterval = totalFrames / 10;
                    if (frameSkipInterval == 0) {
                        frameSkipInterval = 1;
                    }
                    
                    Mat frame = new Mat();
                    BufferedImage bufferedImage = null;

                    for (long currentFrameIndex = 0; currentFrameIndex < totalFrames && i < 10; currentFrameIndex++) {
                        if (cap.read(frame)) {
                            // Process every nth frame based on the calculated interval
                            if (currentFrameIndex % frameSkipInterval == 0) {
                                // Convert the frame to BufferedImage
                                bufferedImage = java2dConverter.convert(matConverter.convert(frame));
                                if (bufferedImage == null) {
                                    System.err.println("Error converting frame to BufferedImage at index: " + currentFrameIndex);
                                    continue;
                                }

                                try {
                                    // Convert BufferedImage to InputStream and predict
                                    ByteArrayOutputStream bos = new ByteArrayOutputStream();
                                    ImageIO.write(bufferedImage, "jpeg", bos);
                                    imgStream = new ByteArrayInputStream(bos.toByteArray());
                                    predcitionPart = model.predict(imgStream);
                                    
                                    // Logik zur Verarbeitung der Vorhersagen
                                    for (int p = 0; p < predcition.length; p++) {
                                        if (predcition[p] < predcitionPart[p]){
                                            predcition[p] = predcitionPart[p];
                                        }
                                        
                                        if (thumbnailImageExtracted.isEmpty() && predcition[p] > this.getDetectionThreshold() && p != 4) {
                                            thumbnailImageExtracted = this.createImageThumbnailBase64(bufferedImage, this.reportThumbnailHeight);
                                            i = 11; // Stop after first hit in one interesting class
                                        }
                                    }
                                } 
                                catch (IOException ex) {
                                    System.err.println("Error processing frame: " + ex.getMessage());
                                    continue;
                                }

                                // Increment the frame counter
                                i++;
                            }
                        } 
                        else {
                            // End of video stream reached 
                            break; 
                        }
                    }
                    
                    frame.release();
                    matConverter.close();
                    java2dConverter.close();
                    cap.release();
                    cap.close();
                }
                
                ///////////////////////////////////////////////////////////////////////////////////////
                /// SKIP ALL OTHER FILES
                ///////////////////////////////////////////////////////////////////////////////////////
                else {
                    continue; 
                }


                ///////////////////////////////////////////////////////////////////////////////////////
                /// CHECK PREDICTION AND REPORT FINDINGS
                ///////////////////////////////////////////////////////////////////////////////////////
                double threshold = this.getDetectionThreshold();
                boolean[] interesting_bool = new boolean[] {predcition[0]>threshold, predcition[1]>threshold, predcition[2]>threshold, predcition[3]>threshold, false, predcition[5]>threshold};

                // Check the hound type, disable unwanted detections
                if (this.getHoundType() != "all" && this.getHoundType() != "documents") {
                    interesting_bool[0] = false; // Disable document detection
                }
                if (this.getHoundType() != "all" && this.getHoundType() != "drugs") {
                    interesting_bool[1] = false; // Disable drug detection
                }
                if (this.getHoundType() != "all" && this.getHoundType() != "ID- or creditcards") {
                    interesting_bool[2] = false; // Disable ID- or creditcards detection
                }
                if (this.getHoundType() != "all" && this.getHoundType() != "money") {
                    interesting_bool[3] = false; // Disable money detection
                }
                if (this.getHoundType() != "all" && this.getHoundType() != "nudity") {
                    interesting_bool[5] = false; // Disable nudity detection
                }

                // Check if any class return true
                for(i = 0; i < 6; i++){
                    if(interesting_bool[i]){
                        this.hitCounter++;

                        String base64Image = "";
                        // Generate thumbnail image from file
                        if (thumbnailImageExtracted == ""){
                            try{
                                base64Image = this.createImageThumbnailBase64(fPath, this.reportThumbnailHeight);
                            }
                            catch (IOException ex) {
                                // Placeholder image
                                base64Image = "data:image/png;base64,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"; 
                            }
                        }
                        else {
                            // Use the extracted thumbnail image for the container file
                            base64Image = thumbnailImageExtracted;
                        }
                        
                        String tr = "<tr>";
                        if(this.hitCounter % 2 == 0) {
                            tr = "<tr style='background-color: #eeeeee;'>";
                        }
                        
                        this.log(tr);
                            this.log("<td><img src='" + base64Image + "'></td>");
                            this.log("<td>" + classes[i] + " (" + String.format("%.2f", predcition[i]*100) + "%)</td>");    
                            this.log("<td><a href='file:///" + fPath + "' target='_blank'>" + fPath + "</a></td>");
                        this.log("</tr>");
                    }
                }

            }
            else if (f.isDirectory()) {
                this.processDirectory(f, model, classes);
            }
        }

        // Enable the start button again after processing
        SwingUtilities.invokeLater(() -> {
            this.startBtn.setEnabled(true);
            this.updateStatus("Analysis completed. Report saved to: " + this.reportFileName);
        });
    }
}